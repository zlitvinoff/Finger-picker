<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Who Goes First</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@300;400;500&display=swap');

* { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

:root {
--bg: #0a0a0f;
--surface: #13131a;
--accent: #ff4d00;
--gold: #ffc340;
--text: #f0ede8;
--muted: #555568;
}

body {
background: var(--bg);
color: var(--text);
font-family: ‘DM Sans’, sans-serif;
height: 100dvh;
overflow: hidden;
display: flex;
flex-direction: column;
user-select: none;
-webkit-user-select: none;
}

body::before {
content: ‘’;
position: fixed;
inset: 0;
background-image: url(“data:image/svg+xml,%3Csvg viewBox=‘0 0 256 256’ xmlns=‘http://www.w3.org/2000/svg’%3E%3Cfilter id=‘noise’%3E%3CfeTurbulence type=‘fractalNoise’ baseFrequency=‘0.9’ numOctaves=‘4’ stitchTiles=‘stitch’/%3E%3C/filter%3E%3Crect width=‘100%25’ height=‘100%25’ filter=‘url(%23noise)’ opacity=‘0.04’/%3E%3C/svg%3E”);
pointer-events: none;
z-index: 100;
opacity: 0.6;
}

#added-overlay {
position: fixed;
inset: 0;
display: flex;
align-items: center;
justify-content: center;
pointer-events: none;
z-index: 200;
opacity: 0;
transition: opacity 0.2s ease;
}
#added-overlay.visible { opacity: 1; }
#added-label {
font-family: ‘Bebas Neue’, sans-serif;
font-size: clamp(3rem, 18vmin, 7rem);
letter-spacing: 0.08em;
color: #000;
text-shadow: 0 0 40px rgba(0,0,0,0.3);
}
@media (prefers-color-scheme: dark) {
#added-label {
color: #fff;
text-shadow: 0 0 40px rgba(255,255,255,0.5), 0 0 80px rgba(255,195,64,0.3);
}
}

#header {
padding: 16px 20px 8px;
display: flex;
align-items: center;
gap: 8px;
flex-shrink: 0;
}

h1 {
font-family: ‘Bebas Neue’, sans-serif;
font-size: 1.8rem;
letter-spacing: 0.08em;
color: var(--text);
margin-right: auto;
}

.pill-btn {
background: var(--surface);
border: 1px solid #2a2a38;
color: var(--muted);
font-family: ‘DM Sans’, sans-serif;
font-size: 0.72rem;
font-weight: 500;
letter-spacing: 0.06em;
text-transform: uppercase;
padding: 6px 13px;
border-radius: 20px;
cursor: pointer;
transition: all 0.2s;
white-space: nowrap;
}
.pill-btn:hover { color: var(--text); border-color: #444; }
.pill-btn.active {
background: #1e1020;
border-color: var(--accent);
color: var(--accent);
}

#sub-config {
padding: 0 20px;
display: flex;
gap: 12px;
align-items: center;
flex-shrink: 0;
max-height: 0;
overflow: hidden;
transition: max-height 0.3s ease, padding 0.3s ease;
}
#sub-config.visible { max-height: 50px; padding-bottom: 8px; }
#sub-config label { font-size: 0.78rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.06em; }
#team-count-input {
background: var(--surface);
border: 1px solid #2a2a38;
color: var(--text);
font-family: ‘DM Sans’, sans-serif;
font-size: 0.85rem;
padding: 5px 10px;
border-radius: 8px;
width: 50px;
text-align: center;
}

#arena {
flex: 1;
position: relative;
display: flex;
align-items: center;
justify-content: center;
overflow: hidden;
}

#arena::before {
content: ‘’;
position: absolute;
width: 60vmin;
height: 60vmin;
border-radius: 50%;
background: radial-gradient(circle, rgba(255,77,0,0.05) 0%, transparent 70%);
pointer-events: none;
}

#prompt {
position: absolute;
text-align: center;
pointer-events: none;
transition: opacity 0.3s;
padding: 24px;
z-index: 10;
}
#prompt-main {
font-family: ‘Bebas Neue’, sans-serif;
font-size: clamp(2rem, 9vmin, 4.5rem);
letter-spacing: 0.05em;
line-height: 1;
color: var(--muted);
}
#prompt-sub {
font-size: 0.78rem;
color: #333348;
text-transform: uppercase;
letter-spacing: 0.12em;
margin-top: 8px;
}

#seq-count {
position: absolute;
bottom: 120px;
left: 50%;
transform: translateX(-50%);
font-family: ‘Bebas Neue’, sans-serif;
font-size: 1rem;
letter-spacing: 0.1em;
color: var(--muted);
opacity: 0;
transition: opacity 0.3s;
pointer-events: none;
white-space: nowrap;
}
#seq-count.visible { opacity: 1; }

.touch-blob {
position: absolute;
transform: translate(-50%, -50%) scale(0);
width: 84px;
height: 84px;
border-radius: 50%;
display: flex;
align-items: center;
justify-content: center;
font-family: ‘Bebas Neue’, sans-serif;
font-size: 1rem;
letter-spacing: 0.05em;
transition: transform 0.15s cubic-bezier(0.34, 1.56, 0.64, 1),
opacity 0.4s ease,
box-shadow 0.3s ease;
pointer-events: none;
}
.touch-blob.active { transform: translate(-50%, -50%) scale(1); }
.touch-blob.frozen.active { transform: translate(-50%, -50%) scale(1); }

.touch-blob.counting { animation: pulse-count 0.9s ease-in-out infinite; }
@keyframes pulse-count {
0%,100% { transform: translate(-50%,-50%) scale(1); }
50%      { transform: translate(-50%,-50%) scale(1.07); }
}

.touch-blob.rank-first {
border-width: 3px !important;
border-color: var(--gold) !important;
animation: winner-pulse 1s ease-in-out infinite;
}
@keyframes winner-pulse {
0%,100% { transform: translate(-50%,-50%) scale(1.05); }
50%      { transform: translate(-50%,-50%) scale(1.14); }
}
.touch-blob.rank-mid {
transform: translate(-50%,-50%) scale(0.9) !important;
transition: transform 0.4s ease, opacity 0.4s ease !important;
opacity: 0.8;
}
.touch-blob.rank-last {
opacity: 0.2 !important;
transform: translate(-50%,-50%) scale(0.62) !important;
transition: transform 0.5s ease, opacity 0.5s ease !important;
}

.blob-ordinal { display: flex; flex-direction: column; align-items: center; line-height: 1; }
.blob-ordinal .num { font-size: 1.5rem; }
.blob-ordinal .suf { font-size: 0.5rem; letter-spacing: 0.05em; margin-top: 1px; opacity: 0.85; }

#inactivity-ring {
position: absolute;
pointer-events: none;
display: none;
z-index: 5;
}
#inactivity-ring circle.track {
fill: none;
stroke: #1e1e2e;
stroke-width: 4;
}
#inactivity-ring circle.prog {
fill: none;
stroke: var(--accent);
stroke-width: 4;
stroke-linecap: round;
transform-origin: center;
transform: rotate(-90deg);
filter: drop-shadow(0 0 5px var(--accent));
}

#countdown-ring {
position: absolute;
pointer-events: none;
display: none;
}
#countdown-ring circle {
fill: none;
stroke: var(--accent);
stroke-width: 3;
stroke-linecap: round;
transform-origin: center;
transform: rotate(-90deg);
filter: drop-shadow(0 0 6px var(--accent));
}

#result-banner {
position: absolute;
bottom: 0; left: 0; right: 0;
padding: 14px 20px 22px;
text-align: center;
opacity: 0;
transform: translateY(20px);
transition: all 0.4s cubic-bezier(0.34,1.56,0.64,1);
pointer-events: none;
background: linear-gradient(to top, rgba(10,10,15,0.97) 65%, transparent);
}
#result-banner.visible { opacity: 1; transform: translateY(0); pointer-events: auto; }

#result-label {
font-size: 0.72rem;
text-transform: uppercase;
letter-spacing: 0.15em;
color: var(--muted);
margin-bottom: 4px;
}
#result-text {
font-family: ‘Bebas Neue’, sans-serif;
font-size: clamp(1.6rem, 7vmin, 3rem);
letter-spacing: 0.05em;
color: var(--gold);
text-shadow: 0 0 28px rgba(255,195,64,0.5);
}

#turn-order-list {
display: none;
flex-wrap: wrap;
justify-content: center;
gap: 5px;
margin: 5px 0 6px;
}
#turn-order-list.visible { display: flex; }
.turn-item {
border-radius: 8px;
padding: 3px 10px;
font-size: 0.76rem;
display: flex;
align-items: center;
gap: 6px;
border: 1px solid rgba(255,255,255,0.08);
background: rgba(0,0,0,0.3);
}
.turn-dot { width: 9px; height: 9px; border-radius: 50%; flex-shrink: 0; }
.turn-pos {
font-family: ‘Bebas Neue’, sans-serif;
font-size: 0.9rem;
color: var(--gold);
letter-spacing: 0.04em;
min-width: 22px;
}
.turn-name { color: #bbb; }

#dismiss-bar-wrap {
margin-top: 10px;
height: 2px;
background: #1a1a28;
border-radius: 2px;
overflow: hidden;
display: none;
}
#dismiss-bar-wrap.visible { display: block; }
#dismiss-bar {
height: 100%;
width: 100%;
background: var(--muted);
transform-origin: left;
transform: scaleX(1);
}

#reset-btn {
margin-top: 10px;
display: none;
background: rgba(255,255,255,0.06);
border: 1px solid #333348;
color: var(--muted);
font-family: ‘DM Sans’, sans-serif;
font-size: 0.72rem;
font-weight: 500;
letter-spacing: 0.1em;
text-transform: uppercase;
padding: 7px 20px;
border-radius: 20px;
cursor: pointer;
transition: all 0.2s;
}
#reset-btn.visible { display: inline-block; }
#reset-btn:hover { color: var(--text); border-color: #555; }

.particle {
position: absolute;
width: 6px; height: 6px;
border-radius: 50%;
pointer-events: none;
animation: burst 0.9s ease-out forwards;
}
@keyframes burst {
0%   { transform: translate(-50%,-50%) scale(1); opacity: 1; }
100% { transform: translate(calc(-50% + var(--dx)), calc(-50% + var(--dy))) scale(0); opacity: 0; }
}
</style>

</head>
<body>

<div id="added-overlay"><span id="added-label">Added!</span></div>

<div id="header">
  <h1>Who Goes First</h1>
  <button class="pill-btn" id="sort-btn">Turn Order</button>
  <button class="pill-btn" id="seq-btn">6+ Mode</button>
  <button class="pill-btn" id="mode-btn">Teams</button>
</div>

<div id="sub-config">
  <label>Teams:</label>
  <input id="team-count-input" type="number" value="2" min="2" max="8">
</div>

<div id="arena">
  <div id="seq-count"></div>
  <div id="prompt">
    <div id="prompt-main">Touch &amp; Hold</div>
    <div id="prompt-sub">Everyone place a finger</div>
  </div>
  <svg id="countdown-ring" width="110" height="110" viewBox="0 0 110 110">
    <circle cx="55" cy="55" r="50" stroke-dasharray="314" stroke-dashoffset="0"/>
  </svg>
  <svg id="inactivity-ring" width="120" height="120" viewBox="0 0 120 120">
    <circle class="track" cx="60" cy="60" r="52"/>
    <circle class="prog" cx="60" cy="60" r="52" stroke-dasharray="327" stroke-dashoffset="0"/>
  </svg>
  <div id="result-banner">
    <div id="result-label">Goes First</div>
    <div id="turn-order-list"></div>
    <div id="result-text">&#8212;</div>
    <div id="dismiss-bar-wrap"><div id="dismiss-bar"></div></div>
    <button id="reset-btn">&#8629; Play Again</button>
  </div>
</div>

<script>
var arena          = document.getElementById('arena');
var promptEl       = document.getElementById('prompt');
var promptMain     = document.getElementById('prompt-main');
var promptSub      = document.getElementById('prompt-sub');
var seqCount       = document.getElementById('seq-count');
var resultBanner   = document.getElementById('result-banner');
var resultLabel    = document.getElementById('result-label');
var resultText     = document.getElementById('result-text');
var turnOrderList  = document.getElementById('turn-order-list');
var modeBtn        = document.getElementById('mode-btn');
var sortBtn        = document.getElementById('sort-btn');
var seqBtn         = document.getElementById('seq-btn');
var subConfig      = document.getElementById('sub-config');
var teamCountInput = document.getElementById('team-count-input');
var ring           = document.getElementById('countdown-ring');
var ringCircle     = ring.querySelector('circle');
var inactRing      = document.getElementById('inactivity-ring');
var inactProg      = inactRing.querySelector('.prog');
var dismissBarWrap = document.getElementById('dismiss-bar-wrap');
var dismissBar     = document.getElementById('dismiss-bar');
var resetBtn       = document.getElementById('reset-btn');
var addedOverlay   = document.getElementById('added-overlay');

var touches        = {};
var frozenBlobs    = [];
var seqPlayers     = [];
var state          = 'waiting';
var nextColorIndex = 0;

var countdownTimer = null;
var countdownStart = null;
var dismissTimer   = null;
var inactRaf       = null;
var inactStart     = null;
var registerTimer  = null;
var addedTimer     = null;

var COUNTDOWN_MS  = 2000;
var DISMISS_MS    = 10000;
var REGISTER_MS   = 2000;
var INACTIVITY_MS = 3000;
var ADDED_DELAY   = 1500;

var teamsMode = false;
var sortMode  = false;
var seqMode   = false;

var ALL_COLORS = [
  { top:'#e03030', bot:'#7a0808', border:'#ff6060', text:'#fff', glow:'255,60,60',   name:'Red'    },
  { top:'#2277ff', bot:'#0d3daa', border:'#66aaff', text:'#fff', glow:'60,130,255',  name:'Blue'   },
  { top:'#22cc55', bot:'#0d7a30', border:'#66ee88', text:'#fff', glow:'50,210,100',  name:'Green'  },
  { top:'#ee9900', bot:'#884400', border:'#ffcc44', text:'#fff', glow:'240,160,20',  name:'Orange' },
  { top:'#cc44ee', bot:'#771199', border:'#ee88ff', text:'#fff', glow:'200,80,240',  name:'Purple' },
  { top:'#00cccc', bot:'#006677', border:'#44eeff', text:'#fff', glow:'20,210,220',  name:'Cyan'   },
  { top:'#ff44aa', bot:'#991155', border:'#ff88cc', text:'#fff', glow:'255,80,180',  name:'Pink'   },
  { top:'#aacc00', bot:'#556600', border:'#ddff44', text:'#111', glow:'180,220,0',   name:'Lime'   },
  { top:'#ff6622', bot:'#882200', border:'#ff9966', text:'#fff', glow:'255,110,60',  name:'Coral'  },
  { top:'#3399ff', bot:'#004488', border:'#88ccff', text:'#fff', glow:'80,180,255',  name:'Sky'    },
  { top:'#ffdd00', bot:'#886600', border:'#ffee66', text:'#111', glow:'255,220,0',   name:'Yellow' },
  { top:'#aa4400', bot:'#552200', border:'#dd8855', text:'#fff', glow:'180,100,40',  name:'Brown'  },
  { top:'#0088aa', bot:'#004455', border:'#33bbdd', text:'#fff', glow:'0,160,200',   name:'Teal'   },
  { top:'#ff2255', bot:'#880022', border:'#ff6688', text:'#fff', glow:'255,50,100',  name:'Rose'   },
  { top:'#7755ee', bot:'#331188', border:'#aa88ff', text:'#fff', glow:'150,120,255', name:'Violet' },
  { top:'#44aa44', bot:'#226622', border:'#77dd77', text:'#fff', glow:'80,200,80',   name:'Sage'   }
];

var TEAM_COLORS = ALL_COLORS.slice(0, 8);
var ORD = ['st','nd','rd','th','th','th','th','th','th','th'];
function ordSuf(n) { return ORD[n-1] || 'th'; }

function applyColor(el, c) {
  el.style.background  = 'radial-gradient(circle at 35% 35%,' + c.top + ',' + c.bot + ')';
  el.style.borderColor = c.border;
  el.style.borderWidth = '2px';
  el.style.borderStyle = 'solid';
  el.style.color       = c.text;
  el.style.boxShadow   = '0 0 22px rgba(' + c.glow + ',0.35)';
}

function getTeamCount() { return Math.max(2, Math.min(8, parseInt(teamCountInput.value) || 2)); }
function getTouchCount() { return Object.keys(touches).length; }

function setPrompt(main, sub, show) {
  promptMain.textContent = main;
  promptSub.textContent  = sub || '';
  promptEl.style.opacity = (show === false) ? '0' : '1';
}

function updateSeqCount() {
  if (!seqMode || seqPlayers.length === 0) { seqCount.classList.remove('visible'); return; }
  seqCount.textContent = seqPlayers.length + ' player' + (seqPlayers.length !== 1 ? 's' : '') + ' registered';
  seqCount.classList.add('visible');
}

function updateSimPrompt() {
  if (state === 'result') return;
  var n = getTouchCount();
  if (n === 0) setPrompt('Touch & Hold', 'Everyone place a finger', true);
  else if (n === 1) setPrompt('Keep Going', '1 finger detected', true);
  else setPrompt('', '', false);
}

function showAdded() { addedOverlay.classList.add('visible'); }
function hideAdded() { addedOverlay.classList.remove('visible'); }

function removeEl(el) { if (el && el.parentNode) el.parentNode.removeChild(el); }

function createBlob(id, x, y, colorIdx) {
  var el = document.createElement('div');
  el.className = 'touch-blob active';
  el.style.left = x + 'px';
  el.style.top  = y + 'px';
  el.textContent = '?';
  applyColor(el, ALL_COLORS[colorIdx]);
  arena.appendChild(el);
  touches[id] = { x:x, y:y, el:el, colorIdx:colorIdx };
}

function removeBlob(id) {
  if (!touches[id]) return;
  var el = touches[id].el;
  if (!el.classList.contains('frozen')) {
    el.style.transform = 'translate(-50%,-50%) scale(0)';
    setTimeout(function(){ removeEl(el); }, 200);
  }
  delete touches[id];
}

function clearLiveTouches() {
  var ids = Object.keys(touches);
  for (var i = 0; i < ids.length; i++) {
    var el = touches[ids[i]].el;
    el.style.transform = 'translate(-50%,-50%) scale(0)';
    el.style.opacity = '0';
    (function(e){ setTimeout(function(){ removeEl(e); }, 300); })(el);
  }
  touches = {};
}

function clearFrozenBlobs() {
  for (var i = 0; i < frozenBlobs.length; i++) {
    var el = frozenBlobs[i];
    el.style.transform = 'translate(-50%,-50%) scale(0)';
    el.style.opacity = '0';
    (function(e){ setTimeout(function(){ removeEl(e); }, 300); })(el);
  }
  frozenBlobs = [];
}

function spawnParticles(x, y, glowRgb) {
  var colors = ['rgb('+glowRgb+')', '#ffffff', '#ffc340'];
  for (var i = 0; i < 16; i++) {
    var p = document.createElement('div');
    p.className = 'particle';
    var angle = (i/16) * Math.PI * 2 + Math.random() * 0.3;
    var dist  = 50 + Math.random() * 70;
    p.style.left = x + 'px';
    p.style.top  = y + 'px';
    p.style.setProperty('--dx', Math.cos(angle)*dist + 'px');
    p.style.setProperty('--dy', Math.sin(angle)*dist + 'px');
    p.style.background = colors[Math.floor(Math.random()*colors.length)];
    arena.appendChild(p);
    (function(e){ setTimeout(function(){ removeEl(e); }, 1000); })(p);
  }
}

function startInactivityRing(ms, onComplete) {
  stopInactivityRing();
  var rect = arena.getBoundingClientRect();
  inactRing.style.display = 'block';
  inactRing.style.left = (rect.width/2 - 60) + 'px';
  inactRing.style.top  = (rect.height/2 - 60 - 80) + 'px';
  inactProg.style.strokeDashoffset = '0';
  inactStart = performance.now();
  function tick(now) {
    var p = Math.min((now - inactStart) / ms, 1);
    inactProg.style.strokeDashoffset = (327 * p).toString();
    if (p < 1) { inactRaf = requestAnimationFrame(tick); }
    else { stopInactivityRing(); if (onComplete) onComplete(); }
  }
  inactRaf = requestAnimationFrame(tick);
}

function stopInactivityRing() {
  if (inactRaf) cancelAnimationFrame(inactRaf);
  inactRaf = null; inactStart = null;
  inactRing.style.display = 'none';
}

function startCountdown() {
  if (state !== 'waiting') return;
  state = 'countdown';
  setPrompt('', '', false);
  var rect = arena.getBoundingClientRect();
  ring.style.display = 'block';
  ring.style.left = (rect.width/2 - 55) + 'px';
  ring.style.top  = (rect.height/2 - 55) + 'px';
  ringCircle.style.strokeDashoffset = '0';
  var ids = Object.keys(touches);
  for (var i = 0; i < ids.length; i++) touches[ids[i]].el.classList.add('counting');
  countdownStart = performance.now();
  function tick(now) {
    if (state !== 'countdown') return;
    var p = Math.min((now - countdownStart) / COUNTDOWN_MS, 1);
    ringCircle.style.strokeDashoffset = (314 * (1 - p)).toString();
    if (p < 1) { countdownTimer = requestAnimationFrame(tick); }
    else { pickSimResult(); }
  }
  countdownTimer = requestAnimationFrame(tick);
}

function cancelCountdown() {
  if (countdownTimer) cancelAnimationFrame(countdownTimer);
  countdownTimer = null;
  state = 'waiting';
  ring.style.display = 'none';
  var ids = Object.keys(touches);
  for (var i = 0; i < ids.length; i++) touches[ids[i]].el.classList.remove('counting');
  updateSimPrompt();
}

function startDismissTimer() {
  dismissBarWrap.classList.add('visible');
  dismissBar.style.transition = 'none';
  dismissBar.style.transform  = 'scaleX(1)';
  dismissBar.getBoundingClientRect();
  dismissBar.style.transition = 'transform ' + DISMISS_MS + 'ms linear';
  dismissBar.style.transform  = 'scaleX(0)';
  dismissTimer = setTimeout(function(){ resetAll(); }, DISMISS_MS);
}

function cancelDismissTimer() {
  if (dismissTimer) clearTimeout(dismissTimer);
  dismissTimer = null;
  dismissBar.style.transition = 'none';
  dismissBar.style.transform  = 'scaleX(0)';
  dismissBarWrap.classList.remove('visible');
}

function spreadPositions(n, w, h) {
  var out = [], margin = 70;
  if (n === 1) { out.push({x:w/2, y:h/2}); return out; }
  for (var i = 0; i < n; i++) {
    var angle = (i/n) * Math.PI * 2 - Math.PI/2;
    out.push({ x: w/2 + (w/2-margin)*0.68*Math.cos(angle), y: h/2 + (h/2-margin)*0.68*Math.sin(angle) });
  }
  return out;
}

// Build the result banner — shared by both modes
function buildResultBanner(playerData) {
  // playerData: [{colorIdx, el, x, y}] in ranked order (index 0 = winner)
  var i, c, item, rank;

  if (!teamsMode) {
    if (!sortMode) {
      c = ALL_COLORS[playerData[0].colorIdx];
      resultLabel.textContent     = 'Goes First';
      resultText.textContent      = c.name;
      resultText.style.color      = c.border;
      resultText.style.textShadow = '0 0 28px rgba('+c.glow+',0.6)';
      turnOrderList.classList.remove('visible');
    } else {
      resultLabel.textContent = 'Turn Order';
      resultText.textContent  = '';
      resultText.style.color  = '';
      resultText.style.textShadow = '';
      turnOrderList.innerHTML = '';
      for (i = 0; i < playerData.length; i++) {
        rank = i + 1;
        c    = ALL_COLORS[playerData[i].colorIdx];
        item = document.createElement('div');
        item.className = 'turn-item';
        item.innerHTML = '<span class="turn-dot" style="background:'+c.top+';box-shadow:0 0 6px rgba('+c.glow+',0.5)"></span><span class="turn-pos">'+rank+ordSuf(rank)+'</span><span class="turn-name" style="color:'+c.border+'">'+c.name+'</span>';
        turnOrderList.appendChild(item);
      }
      turnOrderList.classList.add('visible');
    }
  } else {
    var numTeams = getTeamCount();
    for (i = 0; i < playerData.length; i++) {
      playerData[i].teamIdx = i % numTeams;
      if (playerData[i].el) {
        applyColor(playerData[i].el, TEAM_COLORS[playerData[i].teamIdx]);
        playerData[i].el.classList.remove('rank-first','rank-mid','rank-last','counting');
        playerData[i].el.textContent = TEAM_COLORS[playerData[i].teamIdx].name[0];
      }
    }
    if (!sortMode) {
      resultLabel.textContent = 'Teams Assigned';
      var counts = [];
      for (var t = 0; t < numTeams; t++) {
        var cnt = 0;
        for (i = 0; i < playerData.length; i++) { if (playerData[i].teamIdx === t) cnt++; }
        counts.push(TEAM_COLORS[t].name+': '+cnt);
      }
      resultText.textContent      = counts.join(' · ');
      resultText.style.color      = '';
      resultText.style.textShadow = '';
      turnOrderList.classList.remove('visible');
    } else {
      var teamOrder = [];
      for (var t = 0; t < numTeams; t++) teamOrder.push(t);
      teamOrder.sort(function(){ return Math.random()-0.5; });
      resultLabel.textContent = 'Team Turn Order';
      resultText.textContent  = '';
      resultText.style.color  = '';
      turnOrderList.innerHTML = '';
      for (i = 0; i < teamOrder.length; i++) {
        rank = i + 1;
        c    = TEAM_COLORS[teamOrder[i]];
        item = document.createElement('div');
        item.className = 'turn-item';
        item.innerHTML = '<span class="turn-dot" style="background:'+c.top+';box-shadow:0 0 6px rgba('+c.glow+',0.5)"></span><span class="turn-pos">'+rank+ordSuf(rank)+'</span><span class="turn-name" style="color:'+c.border+'">'+c.name+'</span>';
        turnOrderList.appendChild(item);
      }
      turnOrderList.classList.add('visible');
      var winTeam = teamOrder[0];
      for (i = 0; i < playerData.length; i++) {
        if (playerData[i].teamIdx === winTeam && playerData[i].el) {
          playerData[i].el.classList.add('rank-first');
          c = TEAM_COLORS[winTeam];
          playerData[i].el.style.boxShadow = '0 0 50px rgba('+c.glow+',0.7)';
          spawnParticles(playerData[i].x, playerData[i].y, c.glow);
        }
      }
    }
  }

  resultBanner.classList.add('visible');
  resetBtn.classList.add('visible');
  startDismissTimer();
}

function pickSimResult() {
  state = 'result';
  ring.style.display = 'none';
  var ids = Object.keys(touches);
  if (ids.length === 0) { resetAll(); return; }

  for (var i = 0; i < ids.length; i++) {
    touches[ids[i]].el.classList.add('frozen');
    frozenBlobs.push(touches[ids[i]].el);
  }

  var shuffled = ids.slice().sort(function(){ return Math.random()-0.5; });
  var playerData = [];
  for (var i = 0; i < shuffled.length; i++) {
    var td = touches[shuffled[i]];
    playerData.push({ colorIdx:td.colorIdx, el:td.el, x:td.x, y:td.y });
  }

  if (!teamsMode) {
    for (var i = 0; i < playerData.length; i++) {
      var rank = i + 1;
      var el   = playerData[i].el;
      var c    = ALL_COLORS[playerData[i].colorIdx];
      el.classList.remove('counting');
      if (!sortMode) {
        if (rank === 1) { el.classList.add('rank-first'); el.innerHTML='&#9733;'; el.style.boxShadow='0 0 50px rgba('+c.glow+',0.7),0 0 100px rgba('+c.glow+',0.25)'; spawnParticles(playerData[i].x, playerData[i].y, c.glow); }
        else { el.classList.add('rank-last'); }
      } else {
        if (rank === 1) { el.classList.add('rank-first'); el.style.boxShadow='0 0 50px rgba('+c.glow+',0.7),0 0 100px rgba('+c.glow+',0.25)'; spawnParticles(playerData[i].x, playerData[i].y, c.glow); }
        else if (rank === playerData.length) { el.classList.add('rank-last'); }
        else { el.classList.add('rank-mid'); }
        el.innerHTML='<div class="blob-ordinal"><span class="num">'+rank+'</span><span class="suf">'+ordSuf(rank)+'</span></div>';
      }
    }
  }

  buildResultBanner(playerData);
}

function showSeqResult() {
  state = 'result';
  stopInactivityRing();
  hideAdded();
  setPrompt('', '', false);
  seqCount.classList.remove('visible');
  if (seqPlayers.length === 0) { resetAll(); return; }

  var shuffled = seqPlayers.slice().sort(function(){ return Math.random()-0.5; });
  var rect = arena.getBoundingClientRect();
  var positions = spreadPositions(shuffled.length, rect.width, rect.height);
  var playerData = [];

  for (var i = 0; i < shuffled.length; i++) {
    var p    = shuffled[i];
    var rank = i + 1;
    var c    = ALL_COLORS[p.colorIdx];
    var el   = document.createElement('div');
    el.className = 'touch-blob frozen active';
    el.style.left = positions[i].x + 'px';
    el.style.top  = positions[i].y + 'px';
    applyColor(el, c);
    arena.appendChild(el);
    frozenBlobs.push(el);

    if (!teamsMode) {
      if (!sortMode) {
        if (rank === 1) { el.classList.add('rank-first'); el.innerHTML='&#9733;'; el.style.boxShadow='0 0 50px rgba('+c.glow+',0.7),0 0 100px rgba('+c.glow+',0.25)'; spawnParticles(positions[i].x, positions[i].y, c.glow); }
        else { el.classList.add('rank-last'); }
      } else {
        if (rank === 1) { el.classList.add('rank-first'); el.style.boxShadow='0 0 50px rgba('+c.glow+',0.7),0 0 100px rgba('+c.glow+',0.25)'; spawnParticles(positions[i].x, positions[i].y, c.glow); }
        else if (rank === shuffled.length) { el.classList.add('rank-last'); }
        else { el.classList.add('rank-mid'); }
        el.innerHTML='<div class="blob-ordinal"><span class="num">'+rank+'</span><span class="suf">'+ordSuf(rank)+'</span></div>';
      }
    }

    playerData.push({ colorIdx:p.colorIdx, el:el, x:positions[i].x, y:positions[i].y });
  }

  buildResultBanner(playerData);
}

function resetAll() {
  cancelDismissTimer();
  stopInactivityRing();
  if (countdownTimer) cancelAnimationFrame(countdownTimer);
  if (registerTimer)  clearTimeout(registerTimer);
  if (addedTimer)     clearTimeout(addedTimer);
  countdownTimer = null;
  registerTimer  = null;
  addedTimer     = null;
  state          = 'waiting';
  nextColorIndex = 0;
  seqPlayers     = [];

  ring.style.display = 'none';
  resultBanner.classList.remove('visible');
  turnOrderList.classList.remove('visible');
  resetBtn.classList.remove('visible');
  resultText.style.color      = '';
  resultText.style.textShadow = '';
  seqCount.classList.remove('visible');
  hideAdded();
  clearLiveTouches();
  clearFrozenBlobs();

  if (seqMode) setPrompt('Tap to Register', 'Each player taps in turn', true);
  else         setPrompt('Touch & Hold', 'Everyone place a finger', true);
}

// Mode toggles
sortBtn.addEventListener('click', function(){ sortMode=!sortMode; sortBtn.classList.toggle('active',sortMode); resetAll(); });
seqBtn.addEventListener('click',  function(){ seqMode=!seqMode;   seqBtn.classList.toggle('active',seqMode);   resetAll(); });
modeBtn.addEventListener('click', function(){ teamsMode=!teamsMode; modeBtn.classList.toggle('active',teamsMode); subConfig.classList.toggle('visible',teamsMode); resetAll(); });
resetBtn.addEventListener('click', function(){ resetAll(); });

// Touch events
arena.addEventListener('touchstart', function(e) {
  e.preventDefault();
  if (state === 'result') { resetAll(); return; }
  var rect = arena.getBoundingClientRect();
  var ch   = e.changedTouches;

  if (seqMode) {
    stopInactivityRing();
    if (registerTimer) { clearTimeout(registerTimer); registerTimer = null; }
    // Reset the 1.5s "Added" debounce timer on every new finger
    if (addedTimer) { clearTimeout(addedTimer); addedTimer = null; }
    hideAdded();
    for (var i = 0; i < ch.length; i++) {
      var colorIdx = (seqPlayers.length + getTouchCount()) % ALL_COLORS.length;
      createBlob(ch[i].identifier, ch[i].clientX - rect.left, ch[i].clientY - rect.top, colorIdx);
    }
    state = 'seq-active';
    setPrompt('', '', false);
    // Show "Added!" only after 1.5s of no new fingers arriving
    addedTimer = setTimeout(function() {
      addedTimer = null;
      if (state === 'seq-active') showAdded();
    }, ADDED_DELAY);
  } else {
    for (var i = 0; i < ch.length; i++) {
      createBlob(ch[i].identifier, ch[i].clientX - rect.left, ch[i].clientY - rect.top, nextColorIndex % ALL_COLORS.length);
      nextColorIndex++;
    }
    updateSimPrompt();
    if (getTouchCount() >= 2) {
      // Always restart countdown on each new finger
      if (state === 'countdown') {
        cancelAnimationFrame(countdownTimer);
        countdownTimer = null;
        ring.style.display = 'none';
        state = 'waiting';
      }
      startCountdown();
    }
  }
}, { passive: false });

arena.addEventListener('touchmove', function(e) {
  e.preventDefault();
  if (state === 'result') return;
  var rect = arena.getBoundingClientRect();
  var ch   = e.changedTouches;
  for (var i = 0; i < ch.length; i++) {
    var td = touches[ch[i].identifier];
    if (td) {
      td.x = ch[i].clientX - rect.left;
      td.y = ch[i].clientY - rect.top;
      td.el.style.left = td.x + 'px';
      td.el.style.top  = td.y + 'px';
    }
  }
}, { passive: false });

arena.addEventListener('touchend', function(e) {
  e.preventDefault();
  if (state === 'result') return;
  var ch = e.changedTouches;

  if (seqMode) {
    for (var i = 0; i < ch.length; i++) {
      var id = ch[i].identifier;
      if (!touches[id]) continue;
      var td = touches[id];
      seqPlayers.push({ colorIdx: td.colorIdx, x: td.x, y: td.y });
      removeBlob(id);
    }
    updateSeqCount();

    if (getTouchCount() === 0) {
      if (state === 'seq-active') {
        // First lift after tapping: start register timer, Added is already showing
        state = 'seq-waiting';
        registerTimer = setTimeout(function() {
          registerTimer = null;
          hideAdded();
          clearLiveTouches();
          var n = seqPlayers.length;
          setPrompt('Any more?', n + ' registered  \u2014  tap to add', true);
          updateSeqCount();
          state = 'seq-idle';
          // Start inactivity ring now - no more taps = show result
          startInactivityRing(INACTIVITY_MS, function() {
            if (seqPlayers.length >= 1) showSeqResult();
            else resetAll();
          });
        }, REGISTER_MS);
      } else if (state === 'seq-idle') {
        // Subsequent round lifted - restart inactivity ring
        startInactivityRing(INACTIVITY_MS, function() {
          if (seqPlayers.length >= 1) showSeqResult();
          else resetAll();
        });
      }
    }
  } else {
    for (var i = 0; i < ch.length; i++) removeBlob(ch[i].identifier);
    if (state === 'countdown') cancelCountdown();
    updateSimPrompt();
  }
}, { passive: false });

arena.addEventListener('touchcancel', function(e) {
  e.preventDefault();
  if (state === 'result') return;
  var ch = e.changedTouches;
  for (var i = 0; i < ch.length; i++) removeBlob(ch[i].identifier);
  if (!seqMode && state === 'countdown') cancelCountdown();
  if (!seqMode) updateSimPrompt();
}, { passive: false });

resetAll();
</script>

</body>
</html>